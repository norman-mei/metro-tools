#!/usr/bin/env node
/**
 * Regenerates src/lib/stationTotals.ts based on feature counts
 * for every city under src/app/(game)/** that has data/features.json.
 */
const fs = require('fs')
const path = require('path')

const gameDir = path.join(__dirname, '..', 'src', 'app', '(game)')
const outFile = path.join(__dirname, '..', 'src', 'lib', 'stationTotals.ts')

const totals = {}

const walk = (dir) => {
  for (const entry of fs.readdirSync(dir, { withFileTypes: true })) {
    const entryPath = path.join(dir, entry.name)
    if (entry.isDirectory()) {
      walk(entryPath)
      continue
    }
    if (entry.isFile() && entry.name === 'features.json') {
      const parent = path.basename(dir)
      if (parent !== 'data') continue
      const cityDir = path.basename(path.dirname(dir))
      try {
        const raw = fs.readFileSync(entryPath, 'utf-8')
        const json = JSON.parse(raw)
        if (json && Array.isArray(json.features)) {
          totals[cityDir] = json.features.length
        }
      } catch (err) {
        console.warn(`Skipping ${cityDir}: ${err.message}`)
      }
    }
  }
}

walk(gameDir)

const sorted = Object.keys(totals).sort()

const lines = []
lines.push('// Auto-generated by scripts/generate-station-totals.js')
lines.push('// Do not edit manually.')
lines.push('export const STATION_TOTALS: Record<string, number> = {')
for (const key of sorted) {
  lines.push(`  "${key}": ${totals[key]},`)
}
lines.push('}')
lines.push('')

fs.writeFileSync(outFile, lines.join('\n'))
console.log(`Wrote ${outFile} with ${sorted.length} cities.`)
