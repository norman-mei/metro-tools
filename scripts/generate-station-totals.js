#!/usr/bin/env node
// Generate src/lib/stationTotals.ts from the game data in src/app/(game)/*
// Usage: node scripts/generate-station-totals.js

const fs = require('fs')
const path = require('path')

const GAME_ROOT = path.resolve(__dirname, '..', 'src', 'app', '(game)')
const OUTPUT_FILE = path.resolve(__dirname, '..', 'src', 'lib', 'stationTotals.ts')

/**
 * Read and parse JSON safely. Returns null on failure.
 */
const readJson = (filePath) => {
  try {
    const raw = fs.readFileSync(filePath, 'utf8')
    return JSON.parse(raw)
  } catch (error) {
    console.warn(`⚠️  Failed to read/parse ${filePath}:`, error.message)
    return null
  }
}

/**
 * Count stations for a city based on its features.json (filtered by lines.json if present).
 */
const countStationsForCity = (cityDir) => {
  const featuresPath = path.join(cityDir, 'data', 'features.json')
  if (!fs.existsSync(featuresPath)) {
    console.warn(`⚠️  Skipping ${cityDir}: missing data/features.json`)
    return null
  }

  const linesPath = path.join(cityDir, 'data', 'lines.json')
  const linesJson = fs.existsSync(linesPath) ? readJson(linesPath) : null
  const lineKeys = linesJson && typeof linesJson === 'object' ? new Set(Object.keys(linesJson)) : null

  const featuresJson = readJson(featuresPath)
  if (!featuresJson || !Array.isArray(featuresJson.features)) {
    console.warn(`⚠️  Skipping ${cityDir}: invalid features.json`)
    return null
  }

  const seen = new Set()
  let count = 0

  for (const feature of featuresJson.features) {
    const line = feature?.properties?.line
    if (lineKeys && !lineKeys.has(line)) {
      continue
    }

    const rawId = typeof feature?.id === 'number'
      ? feature.id
      : typeof feature?.properties?.id === 'number'
        ? feature.properties.id
        : null
    const idKey = rawId !== null ? String(rawId) : null

    if (idKey) {
      if (seen.has(idKey)) continue
      seen.add(idKey)
    }

    count += 1
  }

  return count
}

const getCitySlugs = () => {
  if (!fs.existsSync(GAME_ROOT)) {
    throw new Error(`Game root not found: ${GAME_ROOT}`)
  }
  return fs
    .readdirSync(GAME_ROOT, { withFileTypes: true })
    .filter((entry) => entry.isDirectory())
    .map((entry) => entry.name)
}

const main = () => {
  const slugs = getCitySlugs()
  const totals = {}

  for (const slug of slugs) {
    const cityDir = path.join(GAME_ROOT, slug)
    const count = countStationsForCity(cityDir)
    if (count && count > 0) {
      totals[slug] = count
    }
  }

  const sortedEntries = Object.entries(totals).sort(([a], [b]) => a.localeCompare(b))
  const fileContents = `// Auto-generated by scripts/generate-station-totals.js\n` +
    `// Do not edit manually.\n` +
    `export const STATION_TOTALS: Record<string, number> = {\n` +
    sortedEntries.map(([slug, count]) => `  ${JSON.stringify(slug)}: ${count},`).join('\n') +
    '\n}\n'

  fs.writeFileSync(OUTPUT_FILE, fileContents)
  console.log(`✅ Wrote ${sortedEntries.length} station totals to ${OUTPUT_FILE}`)
}

main()
