#!/usr/bin/env node
/**
 * Regenerates src/lib/stationTotals.ts based on feature counts
 * for every city under src/app/(game)/* that has data/features.json.
 */
const fs = require('fs')
const path = require('path')

const gameDir = path.join(__dirname, '..', 'src', 'app', '(game)')
const outFile = path.join(__dirname, '..', 'src', 'lib', 'stationTotals.ts')

function getFeatureCount(cityDir) {
  const featuresPath = path.join(gameDir, cityDir, 'data', 'features.json')
  if (!fs.existsSync(featuresPath)) return null
  try {
    const raw = fs.readFileSync(featuresPath, 'utf-8')
    const json = JSON.parse(raw)
    if (json && Array.isArray(json.features)) return json.features.length
  } catch (err) {
    console.warn(`Skipping ${cityDir}: ${err.message}`)
  }
  return null
}

const totals = {}
for (const entry of fs.readdirSync(gameDir, { withFileTypes: true })) {
  if (!entry.isDirectory()) continue
  const count = getFeatureCount(entry.name)
  if (count != null) totals[entry.name] = count
}

const sorted = Object.keys(totals).sort()

const lines = []
lines.push('// Auto-generated by scripts/generate-station-totals.js')
lines.push('// Do not edit manually.')
lines.push('export const STATION_TOTALS: Record<string, number> = {')
for (const key of sorted) {
  lines.push(`  "${key}": ${totals[key]},`)
}
lines.push('}')
lines.push('')

fs.writeFileSync(outFile, lines.join('\n'))
console.log(`Wrote ${outFile} with ${sorted.length} cities.`)
