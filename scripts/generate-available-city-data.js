#!/usr/bin/env node
/* eslint-disable no-console */

const fs = require('fs/promises')
const path = require('path')

const ROOT = process.cwd()
const DATA_DIR = path.join(ROOT, 'public', 'city-data')
const OUT_FILE = path.join(ROOT, 'src', 'lib', 'availableCityData.ts')

const run = async () => {
  let entries = []
  try {
    entries = await fs.readdir(DATA_DIR)
  } catch (err) {
    console.error(`[generate-available-city-data] Unable to read ${DATA_DIR}`)
    throw err
  }

  const slugs = entries
    .filter((file) => file.endsWith('.json'))
    .map((file) => file.replace(/\.json$/, ''))
    .filter((slug) => slug && slug !== '_placeholder')
    .sort((a, b) => a.localeCompare(b))

  const lines = [
    '// Auto-generated by scripts/generate-available-city-data.js',
    '// Do not edit manually.',
    'export const AVAILABLE_CITY_SLUGS = new Set([',
    ...slugs.map((slug) => `  '${slug}',`),
    '])',
    '',
  ]

  await fs.writeFile(OUT_FILE, lines.join('\n'), 'utf8')
  console.log(`[generate-available-city-data] Updated ${OUT_FILE} (${slugs.length} cities)`)
}

run().catch((err) => {
  console.error(err)
  process.exit(1)
})
